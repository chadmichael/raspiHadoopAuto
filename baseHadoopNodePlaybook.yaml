---
- hosts: raspiHadoopCluster
  remote_user: pi
  become: yes
  tasks:
  - name: create users  
    user: 
      name: hadoop 
      comment: hadoop service account
  - name: verify headless openJDK 8 jre
    apt: 
      name: openjdk-8-jre-headless  
      state: present
      
  # We have to remove all the OpenJDK 11 stuff found on the Raspbian base OS    
  - name: verify absense JRE 11
    apt: 
      name: openjdk-11-jre 
      state: absent
  - name: verify absense jre 11 headless
    apt: 
      name: openjdk-11-jre-headless 
      state: absent  
  - name: verify absense jdk 11                  
    apt: 
      name: openjdk-11-jdk 
      state: absent
  - name: verify absense jdk 11 headless
    apt: 
      name: openjdk-11-jdk-headless 
      state: absent                  

 # Hadoop Dependencies
  - name: Verify Rsync
    apt:
      name: rsync
      state: present

  # Apt Cleanup
  - name: remove useless packages from the cache
    apt:
      autoclean: yes
  - name: remove dependencies that are no longer required
    apt:
      autoremove: yes
    
    
# MASTER 

- hosts: raspiHadoopNameNode
  remote_user: pi
  tasks:
  - name: Create keys for pi user on master node
    openssh_keypair:
      path: ~/.ssh/id_rsa
    notify: 
        - Save Master Keys
  handlers:
    - name: Save Master Keys
      fetch:
        src: /home/pi/.ssh/id_rsa.pub
        dest: keys/nameNode/id_rsa_nameNode.pub
        flat: yes
      notify: 
        - Generate Data Node Authorized Keys
      
# Data Nodes

- hosts: raspiHadoopDataNode
  remote_user: pi
  tasks:   
  - name: Insert/Update configuration using a local file and validate it
    blockinfile:
      block: "{{ lookup('file', 'keys/nameNode/id_rsa_nameNode.pub') }}"
      dest: /home/pi/.ssh/authorized_keys
      insertafter: EOF
      create: yes
        
